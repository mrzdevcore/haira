# Haira AI Rules

> **Purpose**: Strict, enforceable rules for AI agents working on the Haira compiler.
> **Version**: 1.0.0
> **Last Updated**: 2025-12-04

---

## 1. Project Overview

Haira is a **pseudo-natural programming language** where developers express intent and the compiler handles complexity.

### Core Philosophy
- **Express intention, not mechanics**
- **AI-assisted compilation** — AI interprets unresolved function calls
- **Reproducible builds** — deterministic output via caching
- **Native-speed binaries** — compiles to machine code via LLVM

### Tech Stack
- **Language**: Rust 2021 edition
- **Backend**: LLVM (not Cranelift)
- **AI Backends**: Local AI (primary), Ollama (fallback)
- **File Extension**: `.haira`

---

## 2. Compiler Pipeline

The pipeline order is **immutable**. Never reorder these phases:

```
Source (.haira)
    ↓
┌─────────────────┐
│   haira-lexer   │  Source → Tokens
└────────┬────────┘
         ↓
┌─────────────────┐
│  haira-parser   │  Tokens → AST
└────────┬────────┘
         ↓
┌─────────────────┐
│   haira-ast     │  AST definitions
└────────┬────────┘
         ↓
┌─────────────────┐
│ haira-resolver  │  Name resolution, symbol tables
└────────┬────────┘
         ↓
┌─────────────────┐
│   haira-ai      │  AI intent interpretation (unresolved calls)
│ haira-local-ai  │  Local AI backend
└────────┬────────┘
         ↓
┌─────────────────┐
│  haira-types    │  Type inference and checking
└────────┬────────┘
         ↓
┌─────────────────┐
│   haira-hir     │  High-level IR (desugared)
└────────┬────────┘
         ↓
┌─────────────────┐
│   haira-mir     │  Mid-level IR (CFG, SSA)
└────────┬────────┘
         ↓
┌─────────────────┐
│ haira-codegen   │  LLVM IR generation
└────────┬────────┘
         ↓
    Native Binary
```

### Supporting Crates
- `haira-cir` — Canonical IR definitions (AI communication format)
- `haira-runtime` — Standard library (AI-generated, needs wiring)
- `haira-driver` — Compiler orchestration
- `haira-cli` — Command-line interface
- `haira-lsp` — Language Server Protocol

---

## 3. Forbidden Actions

### NEVER Do These

| Action | Status |
|--------|--------|
| Modify files in `spec/` | **FORBIDDEN** — requires explicit permission |
| Use `unsafe` code anywhere | **FORBIDDEN** — no exceptions |
| Reorder compiler pipeline phases | **FORBIDDEN** — immutable architecture |
| Change CIR JSON schema structure | **FORBIDDEN** — breaking change |
| Change crate naming from `haira-*` | **FORBIDDEN** — convention |
| Change file extension from `.haira` | **FORBIDDEN** — language identity |
| Add semicolons to Haira syntax | **FORBIDDEN** — language design |
| Use Claude API as AI backend | **FORBIDDEN** — removed from project |
| Create files in `spec/` | **FORBIDDEN** — frozen directory |

---

## 4. Required Actions

### Before Completing ANY Task

AI agents **MUST** run these commands and ensure they pass:

```bash
# 1. Format code
make fmt

# 2. Run linter (must pass with zero warnings)
make lint

# 3. Build the project
make build

# 4. Run all tests
cargo test
```

**Do NOT mark a task as complete if any of these fail.**

### Before Writing New Code

AI agents **MUST**:

1. **Search for existing code first**
   - Use `Grep` to find similar functionality
   - Use `Glob` to find related files
   - Check if a function/type already exists
   - **Prevent dead code and duplication**

2. **Read before editing**
   - Always read a file before modifying it
   - Understand the existing patterns
   - Follow the established conventions

3. **Check crate boundaries**
   - Understand which crate owns the functionality
   - Don't duplicate across crates
   - Respect the pipeline order

---

## 5. Code Standards

### Rust Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Crate names | `haira-*` (hyphenated) | `haira-lexer` |
| Module names | `snake_case` | `token_stream` |
| Function names | `snake_case` | `parse_expression` |
| Type/Struct names | `PascalCase` | `TokenKind` |
| Constants | `SCREAMING_SNAKE_CASE` | `MAX_RECURSION_DEPTH` |

### Visibility Rules

```rust
// PREFER: Internal by default
pub(crate) fn internal_helper() { }

// ONLY for intentional public API
pub fn public_api_function() { }

// Private for implementation details
fn private_impl() { }
```

### Error Handling

All crates **MUST** use:

```rust
// Error definitions with thiserror
use thiserror::Error;

#[derive(Error, Debug)]
pub enum MyError {
    #[error("descriptive message: {0}")]
    Variant(String),
}

// Error display with miette (for user-facing errors)
use miette::Diagnostic;

#[derive(Error, Diagnostic, Debug)]
#[error("user-friendly message")]
#[diagnostic(code(haira::error_code))]
pub struct UserFacingError {
    #[source_code]
    src: String,
    #[label("this is wrong")]
    span: SourceSpan,
}
```

### Span Tracking

**Every** AST, HIR, and MIR node **MUST** carry a `Span`:

```rust
// CORRECT: Node with span
pub struct Expr {
    pub kind: ExprKind,
    pub span: Span,  // Required for error reporting
}

// WRONG: Node without span
pub struct Expr {
    pub kind: ExprKind,
    // Missing span!
}
```

---

## 6. Dead Code Policy

### Immediate Removal

- **Remove dead code immediately** — no deprecation period
- **Remove unused imports** — clippy will catch these
- **Remove unused functions** — if not called, delete
- **Remove commented-out code** — version control exists

### Detection

```bash
# Clippy will catch dead code
make lint

# If you see warnings like:
# warning: unused function `foo`
# → Delete it immediately
```

---

## 7. AI Integration Architecture

### Formats

| Format | Purpose | Location |
|--------|---------|----------|
| **CIR** (Canonical IR) | AI communication | In-memory, API responses |
| **HIF** (Haira Intent Format) | Cache files | `.haira-cache/*.hif` |

### AI Backend Priority

1. **Local AI** (primary) — `haira-local-ai` crate
2. **Ollama** (fallback) — `haira-ai` crate with Ollama backend

**Claude API has been removed from the project.**

### Cache Flow

```
Unresolved Call
       ↓
  Check HIF Cache (hash match?)
       ↓ miss
  Call Local AI / Ollama
       ↓
  Receive CIR (JSON)
       ↓
  Validate CIR
       ↓
  Convert to AST
       ↓
  Save as HIF (cache)
```

---

## 8. Project Structure

```
haira/
├── Cargo.toml              # Workspace definition
├── Makefile                # Build commands
├── .AI_RULES.md            # This file
├── spec/                   # FROZEN: Language specification
│   └── *.md                # Do NOT modify without permission
├── crates/
│   ├── haira-lexer/        # Tokenization
│   ├── haira-parser/       # AST generation
│   ├── haira-ast/          # AST definitions
│   ├── haira-resolver/     # Name resolution
│   ├── haira-ai/           # AI intent engine
│   ├── haira-local-ai/     # Local AI backend
│   ├── haira-cir/          # Canonical IR definitions
│   ├── haira-types/        # Type system
│   ├── haira-hir/          # High-level IR
│   ├── haira-mir/          # Mid-level IR
│   ├── haira-codegen/      # LLVM code generation
│   ├── haira-runtime/      # Standard library (wire if needed)
│   ├── haira-driver/       # Compiler driver
│   ├── haira-cli/          # CLI interface
│   └── haira-lsp/          # Language server
├── examples/
│   ├── ai/                 # AI-dependent examples
│   └── testing/            # Test fixtures
└── .haira-cache/           # HIF cache (gitignored)
```

---

## 9. Crate Responsibilities

| Crate | Responsibility | Can Depend On |
|-------|----------------|---------------|
| `haira-lexer` | Tokenization | (none) |
| `haira-ast` | AST node definitions | (none) |
| `haira-parser` | Parsing tokens → AST | lexer, ast |
| `haira-resolver` | Name resolution | ast |
| `haira-cir` | CIR type definitions | (none) |
| `haira-ai` | AI orchestration | cir, ast |
| `haira-local-ai` | Local AI backend | (external AI libs) |
| `haira-types` | Type inference | ast, resolver |
| `haira-hir` | HIR definitions | ast, types |
| `haira-mir` | MIR definitions | hir |
| `haira-codegen` | LLVM codegen | mir, hir, ast |
| `haira-runtime` | Standard library | (runtime deps) |
| `haira-driver` | Orchestration | all above |
| `haira-cli` | CLI | driver |
| `haira-lsp` | LSP | driver, ast |

---

## 10. Testing Requirements

### Test Location

- Unit tests: `#[cfg(test)]` modules in same file
- Integration tests: `tests/` directory in each crate
- Example programs: `examples/` directory

### Test Patterns

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_specific_behavior() {
        // Arrange
        let input = "...";
        
        // Act
        let result = function_under_test(input);
        
        // Assert
        assert_eq!(result, expected);
    }
}
```

### Running Tests

```bash
# Run all tests
cargo test

# Run tests for specific crate
cargo test -p haira-parser

# Run with output
cargo test -- --nocapture
```

---

## 11. Common Tasks

### Adding a New AST Node

1. Define in `haira-ast/src/ast.rs`
2. Add span field
3. Update parser in `haira-parser`
4. Update any visitors/walkers
5. Run `make dev`

### Adding a New CIR Operation

1. Define in `haira-cir/src/`
2. Update CIR → AST conversion
3. Update HIF serialization if needed
4. Run `make dev`

### Adding a New Compiler Pass

1. Identify correct phase (HIR/MIR)
2. Create in appropriate crate
3. Wire into driver
4. Add tests
5. Run `make dev`

---

## 12. Checklist for AI Agents

Before starting any task:

- [ ] Read this `.AI_RULES.md` file
- [ ] Search for existing related code
- [ ] Understand which crate to modify
- [ ] Check if functionality already exists

Before completing any task:

- [ ] `make fmt` passes
- [ ] `make lint` passes (zero warnings)
- [ ] `make build` succeeds
- [ ] `cargo test` passes
- [ ] No dead code introduced
- [ ] Spans included on all nodes
- [ ] Error handling uses thiserror + miette
- [ ] Visibility is minimal (`pub(crate)` preferred)

---

## 13. Quick Reference

### Must Do
- Search existing code before writing new code
- Run `make fmt && make lint && make build && cargo test`
- Use `thiserror` + `miette` for errors
- Include `Span` on every AST/HIR/MIR node
- Prefer `pub(crate)` over `pub`
- Remove dead code immediately

### Must Not
- Modify `spec/` without permission
- Use `unsafe` code
- Use Claude API
- Reorder compiler pipeline
- Change CIR schema
- Introduce dead code

### File Extension
- Haira source: `.haira`
- Cache files: `.hif`

### AI Backends
1. Local AI (primary)
2. Ollama (fallback)

---

## 14. Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-04 | Initial version |

---

*This document is the source of truth for AI agents working on Haira.*
